# 21.03.2015
# http://rforfinance.ru/pairs-trade/

start.date <- "2009-01-01"
end.date <- "2015-01-01"

library(quantmod)

getSymbols("MA", from = start.date, to = end.date)
getSymbols("V", from = start.date, to = end.date)
plot(Ad(MA), main = "In search of cointegration: V & MA")
lines(Ad(V), col = 2)

summary(lm(Ad(V) ~ Ad(MA)))
# R-?????????????? 0.98! ?????? ?????? ?????? ???????????? ????????. ?????????? ???????????????? ??????-???? ????????????.

# ?? ?????? ???????? ???????????? ???? 6 ??????. ???????????????? ???????????? ???? ???????????? 4 ??????????, ?? 2 ?????????????????? ?????????????? ?????? ????????????????.
train.end <- "2013-01-01"

V.train <- window(Ad(V), start = start.date, end = train.end)
MA.train <- window(Ad(MA), start = start.date, end = train.end)

V.test <- window(Ad(V), start = train.end, end = end.date)
MA.test <- window(Ad(MA), start = train.end, end = end.date)

# ???????????? ???????????????? ???????? ???????????????? ???????????? ???? ?????????????? ???? ?? ?????????? ??????????????????????????:
pairsModel <- lm(MA.train ~ V.train)
summary(pairsModel)

# ??????????????????, ?????? ???????????????? ?????????????? ?????????? ???????????? ?? ???????????????? ??????????????:
plot(pairsModel$residuals, main="Residuals on test data")

# ?????????????????? ????????????: ?????????? ?????????????? ?????????????? ????????????????? 
# ?????? ?????????????? ?????????? ?????????? ???????? ?????????????????????? ????????????????????
# (?? ???????????????????????????? ???????????????????????????????????? ?? ?????????????? ????????????????):
border.top <- sd(pairsModel$residuals)
border.bottom <- -sd(pairsModel$residuals)

plot(pairsModel$residuals, main="Residuals on test data, now with borders")

abline(h = border.top, col = 3, lty = 2)
abline(h = border.bottom, col = 2, lty = 2)
# ?? ?????????? ???? ???????????????????? ?????? ???? ????????????, ???? ???????????????? ??????????, ???? ?????????????? ???? ?????????? ?????????????????? ???????????????? ??????????????.

# ?? ?????? ???????????? ?????????????????? ????????????????. 
# ?????????? ????????????????, ?????? ???????? ???? ???????????????? ???????????????????? ???????????? ?? ?????? ?????????????? ???????????????????????? a ?? b, 
# ???? ???????? ?????????? ???????????????????? ???????????????? (a+b)/2. ?????? ?? ??????????????. 
# ?? ???????????? ???? ?????????? ?????????? ?? ???????????? ???????????????? ?????? ???????????? ???????????? ?? ?????????? ?????????????? ???????????????????? ?????????? ??????????????????. 
# ???????????? ???????????? ?????????????? ???????????????????? ?????????? ?????????? (?????????????????? ??????????????????, 
# ?????? ?????????????? ?? ?????????????? ???????????? PerformanceAnalytics, ???? ?????? ?????? ?????????? ?????? ????????????????????):
library("PerformanceAnalytics")

V.ret <- lag(Return.calculate(V.test), -1)
MA.ret <- lag(Return.calculate(MA.test), -1)

# ???????????? ?? ???????????? (???? ?????????? ???????? time series) ?????????? ???????????????????? ???????????????????? ???????????????????? ?????????? ??????????????????. 
# ?? ???????????????????????? ?? ?????????????????????? ???????? ??????????????, ?????? ??????????:

# ?????????? ???????????????????? ???? ????????????:
residuals <- MA.test - (V.test*pairsModel$coefficients[2] + pairsModel$coefficients[1])

# ???????? ???????????????????? ???????? border.top, ???? MA ?? ????????, ?? V ?? ????????. 
# ?????? ????????????, ?????? ???????? ???????????????????? ?????????? ?????????? (-MA.ret + V.ret)/2.
# ???????? ???? ???????? ???????????? ?????????????? ????????????????, ???? ???????????????????? ?????????? (MA.ret — V.ret)/2. 
# ?? ???????? ???? ?? ????????????????, ???? ???? ???? ?????????????? ?? ???????????????????? ?????????? 0.
pairsRet <- ifelse(residuals > border.top, (-MA.ret + V.ret)/2, ifelse(residuals < border.bottom, (MA.ret - V.ret)/2, 0))

# ???????????? ?????????? ?????????????????????? ??????????. ?????? ?????????????????? ?????????????? ???????????????????? ???????????????? 50/50 Visa ?? MasterCard.
Portf <- (V.ret + MA.ret)/2
str <- cbind(pairsRet, Portf)
colnames(str) <- c("Pairs trade", "50/50 portfolio")
charts.PerformanceSummary(str)

table.AnnualizedReturns(str)
maxDrawdown(str)

# ??????????????, ?????? ???? ?????????????? ???? ????????????????, ???????? ???????? ???????????????????? ?????????? 5.6% ??????????????, 
# ?? ?? ???????????????? 31.2% ??????????????. ???? ?????? ?? ?????? ?????? ????????. 
# ???????? ?????????????????? ???????? ????????-???????? ?????????????????????? ?? ?????????????????????????????? ?????????????????????? ??????????????????????, 
# ???? ???????? ???? ???????????????????? ???? ???????????? ???? ????????????????????, ???????? ???? ?????? ?????????? ????????????. 
# ?? ?????? ???????????????????? ???????????????? ???????????????????? ???? ?????????????????????? 
# (???? ?????????? ???????? ???????? ?????????? ???? 30% ?? ?????? — ???????? ???????????????? ????????????????????).
# ???? ???????? ???????? ?????????????????? ?????????? ??????????????????????, ???? ?????????? ???????????????????? ?? ???? ???????????????? ??????????. 
# ?????? ?????????? ???? ??????????????: ???????????????????????? ?????????????? ?????????? ?????????????????? ?????????? 4%, ?? ???????????????? — 16%. 
# ?????????? ??????????, ???????? ?????????????????? ???????????????? ?????????? ???????????? ???? ??????????????????, 
# ?? ???????????? ???????????? ?????????? ???????????? ?? ?????????? ?? ?????????????????? ?????????????????????? ??????????.

                                                                       